@if (isHistoryImportPending()) {
<!-- Optimistic UI: Show queued status immediately using Shared Callout Component -->
<div class="status-container">
  @if (serviceName === serviceNames.SuuntoApp || serviceName === serviceNames.COROSAPI) {
  @if (pendingImportResult()) {
  <app-status-info type="success" title="Import Queued">
    {{ pendingImportResult()!.successCount }} activities queued.
    Estimated completion in {{ Math.ceil(pendingImportResult()!.successCount / activitiesPerDayLimit) || 1 }} {{
    (Math.ceil(pendingImportResult()!.successCount / activitiesPerDayLimit) || 1) === 1 ? 'day' : 'days' }}.
    (~{{ activitiesPerDayLimit }} / day)
  </app-status-info>
  } @else {
  <app-status-info type="pending" title="Processing Request">
    Your history import is being processed...
  </app-status-info>
  }
  } @else if (serviceName === serviceNames.GarminAPI) {
  <app-status-info type="success" title="Import Requested">
    Garmin will push activities to your account over the coming hours/days.
  </app-status-info>

  <app-status-info type="pending" [title]="garminCooldownDays + '-Day Cooldown'">
    Next import available in {{ garminCooldownDays }} days.
  </app-status-info>
  }
</div>
} @else if (userMetaForService && userMetaForService.didLastHistoryImport && !isAllowedToDoHistoryImport) {
<div class="status-container">
  @if (serviceName === serviceNames.SuuntoApp || serviceName === serviceNames.COROSAPI) {
  <app-status-info type="success" title="Import In Progress">
    {{ userMetaForService.processedActivitiesFromLastHistoryImportCount }} activities queued from last import.
    Cooldown active for {{ cooldownDays }} {{ cooldownDays === 1 ? 'day' : 'days' }}.
  </app-status-info>

  <app-status-info title="Next Available Import">
    {{ nextImportAvailableDate | date: 'medium' }}
  </app-status-info>

  } @else if (serviceName === serviceNames.GarminAPI) {
  <app-status-info type="success" title="Import Active">
    Activities are arriving via Garmin push.
  </app-status-info>

  <app-status-info title="Cooldown Active">
    New import available on {{ nextImportAvailableDate | date: 'medium' }}.
  </app-status-info>
  }
</div>
}

@if (formGroup && isAllowedToDoHistoryImport && !isHistoryImportPending()) {
@if (isPro) {
<form [formGroup]="formGroup" class="qs-form history-import-form">
  @if (isMissingGarminPermissions) {
  <div class="qs-warning-box" style="margin-bottom: 24px;">
    <mat-icon>warning</mat-icon>
    <div class="qs-warning-content">
      <strong>Missing Permissions</strong>
      <p>
        Export permissions are required for history import. Please reconnect to Garmin and grant all permissions.
      </p>
    </div>
  </div>
  }
  @if (serviceName === serviceNames.GarminAPI) {
  <app-status-info [title]="garminCooldownDays + '-Day Cooldown â€¢ 5-Year Max Range'">
    Garmin's API limits history imports to once per month and a maximum of 5 years of data per request.
  </app-status-info>
  }
  @if (minDate && serviceName === serviceNames.COROSAPI) {
  <app-status-info [title]="corosHistoryLimitMonths + '-Month Import Limit'">
    Dates before {{ minDate | date:'mediumDate' }} are disabled in the picker due to API restrictions.
  </app-status-info>
  }
  <div class="date-fields">
    <mat-form-field appearance="outline">
      <mat-label>Start Date</mat-label>
      <input matInput [matDatepicker]="startDate" [min]="minDate" [max]="formGroup.get('endDate')?.value || today"
        formControlName="startDate" (click)="startDate.open()">
      <mat-datepicker-toggle matSuffix [for]="startDate"></mat-datepicker-toggle>
      <mat-datepicker #startDate></mat-datepicker>
      <mat-error *ngIf="formGroup.get('startDate')?.hasError('required')">Start date is required</mat-error>
    </mat-form-field>
    <mat-form-field appearance="outline">
      <mat-label>End Date</mat-label>
      <input matInput [matDatepicker]="endDate" [min]="formGroup.get('startDate')?.value || minDate" [max]="today"
        formControlName="endDate" (click)="endDate.open()">
      <mat-datepicker-toggle matSuffix [for]="endDate"></mat-datepicker-toggle>
      <mat-datepicker #endDate></mat-datepicker>
      <mat-error *ngIf="formGroup.get('endDate')?.hasError('required')">End date is required</mat-error>
      <mat-error *ngIf="formGroup.get('endDate')?.hasError('dateRangeInvalid')">End date cannot be before start
        date</mat-error>
    </mat-form-field>
  </div>
  <div class="confirmation-section">
    <mat-checkbox formControlName="accepted" color="primary">
      <span class="checkbox-label">
        @if (serviceName === serviceNames.SuuntoApp || serviceName === serviceNames.COROSAPI) {
        I understand this may take hours to days.
        }
        @if (serviceName === serviceNames.GarminAPI) {
        I understand I can only import once every {{garminCooldownDays}} days (Garmin API limit).
        }
      </span>
    </mat-checkbox>
  </div>
  <div class="qs-form-actions">
    <button mat-flat-button color="primary" (click)="onSubmit($event)"
      [disabled]="!formGroup.valid || isSubmitting || isLoadingParent || formGroup.disabled">
      @if (isSubmitting) {
      <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
        color="accent"></mat-spinner>
      Importing History...
      } @else {
      Import History
      }
    </button>
  </div>
</form>
} @else {
<div class="pro-required">
  <p>History import is a Pro feature.</p>
  <button mat-flat-button color="primary" routerLink="/pricing">Upgrade to Pro</button>
</div>
}
}