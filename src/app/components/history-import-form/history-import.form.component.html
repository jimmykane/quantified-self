@if (userMetaForService && userMetaForService.didLastHistoryImport && !isAllowedToDoHistoryImport) {
<mat-card class="status-card">
  <mat-card-header>
    <mat-icon mat-card-avatar>history_toggle_off</mat-icon>
    <mat-card-title>Import Status</mat-card-title>
    <mat-card-subtitle>Last import: {{ userMetaForService.didLastHistoryImport | date: 'short' }}</mat-card-subtitle>
  </mat-card-header>
  <mat-card-content>
    <mat-list role="list">
      @if (serviceName === serviceNames.SuuntoApp || serviceName === serviceNames.COROSAPI) {
      <mat-list-item role="listitem">
        <mat-icon matListItemIcon>queue</mat-icon>
        <div matListItemTitle>Queued Activities</div>
        <div matListItemLine class="stats-value">{{ userMetaForService.processedActivitiesFromLastHistoryImportCount }}
        </div>
      </mat-list-item>
      <mat-list-item role="listitem">
        <mat-icon matListItemIcon>info</mat-icon>
        <div matListItemTitle>Cooldown Period</div>
        <div matListItemLine>
          <mat-chip-listbox>
            <mat-chip-option highlighted color="warn" [selectable]="false">{{ cooldownDays }} days</mat-chip-option>
          </mat-chip-listbox>
        </div>
        <p matListItemLine class="mat-caption text-secondary">~{{ activitiesPerDayLimit }} activities/day limit</p>
      </mat-list-item>
      } @else if (serviceName === serviceNames.GarminAPI) {
      <mat-list-item role="listitem">
        <mat-icon matListItemIcon>timer</mat-icon>
        <div matListItemTitle>Cooldown</div>
        <div matListItemLine>
          <mat-chip-listbox>
            <mat-chip-option highlighted color="accent" [selectable]="false">{{ garminCooldownDays }} days
              fixed</mat-chip-option>
          </mat-chip-listbox>
        </div>
      </mat-list-item>
      }
      <mat-divider></mat-divider>
      <mat-list-item role="listitem">
        <mat-icon matListItemIcon>event_available</mat-icon>
        <div matListItemTitle>Next Available Import</div>
        <div matListItemLine class="date-highlight">{{ nextImportAvailableDate | date: 'medium' }}</div>
      </mat-list-item>
    </mat-list>
  </mat-card-content>
</mat-card>
}

@if (formGroup && isAllowedToDoHistoryImport) {
@if (isPro) {
<form [formGroup]="formGroup" class="qs-form history-import-form">
  @if (isMissingGarminPermissions) {
  <div class="qs-warning-box" style="margin-bottom: 24px;">
    <mat-icon>warning</mat-icon>
    <div class="qs-warning-content">
      <strong>Missing Permissions</strong>
      <p>
        Export permissions are required for history import. Please reconnect to Garmin and grant all permissions.
      </p>
    </div>
  </div>
  }
  @if (minDate && serviceName === serviceNames.COROSAPI) {
  <div class="limit-info">
    <mat-icon>info</mat-icon>
    <div class="limit-text">
      <span class="limit-title">{{corosHistoryLimitMonths}}-Month Import Limit</span>
      <p class="limit-description">
        Dates before {{ minDate | date:'mediumDate' }} are disabled in the picker due to API restrictions.
      </p>
    </div>
  </div>
  }
  <div class="date-fields">
    <mat-form-field appearance="outline">
      <mat-label>Start Date</mat-label>
      <input matInput [matDatepicker]="startDate" [min]="minDate" formControlName="startDate"
        (click)="startDate.open()">
      <mat-datepicker-toggle matSuffix [for]="startDate"></mat-datepicker-toggle>
      <mat-datepicker #startDate></mat-datepicker>
    </mat-form-field>
    <mat-form-field appearance="outline">
      <mat-label>End Date</mat-label>
      <input matInput [matDatepicker]="endDate" formControlName="endDate" (click)="endDate.open()">
      <mat-datepicker-toggle matSuffix [for]="endDate"></mat-datepicker-toggle>
      <mat-datepicker #endDate></mat-datepicker>
    </mat-form-field>
  </div>
  <div class="confirmation-section">
    <mat-checkbox formControlName="accepted" color="primary">
      <span class="checkbox-label">
        @if (serviceName === serviceNames.SuuntoApp || serviceName === serviceNames.COROSAPI) {
        I understand this may take hours to days.
        }
        @if (serviceName === serviceNames.GarminAPI) {
        I understand I can only import every 3 days.
        }
      </span>
    </mat-checkbox>
  </div>
  <div class="qs-form-actions">
    <button mat-flat-button color="primary" (click)="onSubmit($event)"
      [disabled]="!formGroup.valid || isLoading || formGroup.disabled">
      @if (isLoading) {
      <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
        color="accent"></mat-spinner>
      Importing History...
      } @else {
      Import History
      }
    </button>
  </div>
</form>
} @else {
<div class="pro-required">
  <p>History import is a Pro feature.</p>
  <button mat-flat-button color="primary" routerLink="/pricing">Upgrade to Pro</button>
</div>
}
}