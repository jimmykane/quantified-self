<div class="settings-container">

  <!-- Global Profile Header -->
  <div style="padding: 32px 40px 0 40px; margin: 0 auto;">
    <div class="user-profile-header app-header-card">
      <div class="header-content">
        <div class="header-avatar"
          [style.backgroundImage]="'url('+ (user.photoURL ? user.photoURL :  'https://ui-avatars.com/api/?name=' + (this.user.displayName || 'Guest') ) +')'">
        </div>
        <div class="header-info">
          <div class="name-row">
            <app-privacy-icon [privacy]="user.privacy"></app-privacy-icon>
            <div class="user-display-name-wrapper">
              <h2 class="user-display-name">{{ user.displayName }}</h2>
              @if (isProUser) {
              <span class="pro-badge">
                <mat-icon>verified</mat-icon>
                PRO
              </span>
              } @else if (isBasicUser) {
              <span class="basic-badge">
                <mat-icon>verified</mat-icon>
                BASIC
              </span>
              }
            </div>
          </div>
          <p class="user-id">ID: {{ user.uid }}</p>
          @if (user.description) {
          <p class="user-bio">{{ user.description }}</p>
          }
        </div>
      </div>
      <div class="header-actions">
        <app-user-actions [user]="user"></app-user-actions>
      </div>
    </div>
  </div>

  <!-- Horizontal Navigation -->
  <nav class="settings-nav">
    <ul class="nav-list">
      <li class="nav-item" [class.active]="activeSection === 'profile'" (click)="activeSection = 'profile'">
        <mat-icon>person</mat-icon> Profile
      </li>
      <li class="nav-item" [class.active]="activeSection === 'app'" (click)="activeSection = 'app'">
        <mat-icon>settings</mat-icon> General
      </li>
      <li class="nav-item" [class.active]="activeSection === 'dashboard'" (click)="activeSection = 'dashboard'">
        <mat-icon>dashboard</mat-icon> Dashboard
      </li>
      <li class="nav-item" [class.active]="activeSection === 'map'" (click)="activeSection = 'map'">
        <mat-icon>map</mat-icon> Maps
      </li>
      <li class="nav-item" [class.active]="activeSection === 'charts'" (click)="activeSection = 'charts'">
        <mat-icon>show_chart</mat-icon> Charts
      </li>
      <li class="nav-item" [class.active]="activeSection === 'units'" (click)="activeSection = 'units'">
        <mat-icon>straighten</mat-icon> Units
      </li>
    </ul>
  </nav>

  <!-- Main Content Area -->
  <main class="settings-content">
    <form [formGroup]="userSettingsFormGroup" (submit)="onSubmit($event)" class="qs-form">

      <!-- Profile Section -->
      @if (activeSection === 'profile') {
      <mat-card class="settings-card glass-card">
        <div style="padding: 24px; padding-bottom: 0;">
          <h1 style="margin: 0 0 8px 0; font-size: 1.8rem; font-weight: 800;">Profile Settings</h1>
          <p style="margin: 0; opacity: 0.7; font-size: 1rem;">Manage your public persona and account visibility.</p>
        </div>
        <div class="card-content">
          <mat-form-field appearance="outline">
            <mat-label>Public Name</mat-label>
            <input matInput formControlName="displayName">
            <mat-hint>The name other users will see on your profile.</mat-hint>
            @if (hasError('displayName')) {
            <mat-error>Public name is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Profile Visibility</mat-label>
            <mat-select formControlName="privacy">
              <mat-option [value]="privacy.Public">Public</mat-option>
              <mat-option [value]="privacy.Private">Private</mat-option>
            </mat-select>
            <mat-hint>Choose who can see your activities and profile stats.</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>About You</mat-label>
            <textarea matInput rows="3" formControlName="description"
              placeholder="Tell the community about your sporting journey..."></textarea>
            <mat-hint>A brief description for your public profile.</mat-hint>
          </mat-form-field>

        </div>
      </mat-card>

      <!-- Danger Zone -->
      <mat-card class="settings-card danger-card">
        <div class="card-content">
          <div class="danger-title">
            <mat-icon>warning</mat-icon>
            <span>Danger Zone</span>
          </div>
          <p>
            Deleting your account will permanently remove all your activities, settings, connected services,
            and any other associated data. If you have an active subscription, it will also be cancelled.
            This action cannot be undone.
          </p>

          <div style="margin-top: 16px;">
            <button mat-stroked-button color="warn" (click)="deleteUser($event)">
              <mat-icon>delete_forever</mat-icon>
              Delete My Account
            </button>
          </div>
        </div>
      </mat-card>
      }

      <!-- General App Settings -->
      @if (activeSection === 'app') {
      <mat-card class="settings-card glass-card">
        <div style="padding: 24px; padding-bottom: 0;">
          <h1 style="margin: 0 0 8px 0; font-size: 1.8rem; font-weight: 800;">General Settings</h1>
          <p style="margin: 0; opacity: 0.7; font-size: 1rem;">Customize your application experience.</p>
        </div>
        <div class="card-content">
          <mat-form-field appearance="outline">
            <mat-label>Interface Theme</mat-label>
            <mat-select formControlName="appTheme">
              @for (appTheme of appThemes | keyvalue; track appTheme) {
              <mat-option [value]="appTheme.value">
                {{appTheme.key}}
              </mat-option>
              }
            </mat-select>
            <mat-hint>Customize the visual look of the entire platform.</mat-hint>
          </mat-form-field>

          <div style="margin-top: 16px;">
            <mat-slide-toggle formControlName="acceptedTrackingPolicy">
              Allow Anonymous Usage Statistics
            </mat-slide-toggle>
            <p style="margin: 8px 0 0 0; opacity: 0.7; font-size: 0.8rem;">
              Help us improve by sharing anonymous usage data. Disabling this will stop all analytics tracking.
            </p>
          </div>

          <div style="margin-top: 16px;">
            <mat-slide-toggle formControlName="acceptedMarketingPolicy">
              Allow Marketing & Update Emails (Optional)
            </mat-slide-toggle>
            <p style="margin: 8px 0 0 0; opacity: 0.7; font-size: 0.8rem;">
              Receive occasional updates about new features, promotions, and special offers. You can manage this setting
              here at any time.
            </p>
          </div>
        </div>
      </mat-card>
      }

      <!-- Dashboard Settings -->
      @if (activeSection === 'dashboard') {
      <mat-card class="settings-card glass-card">
        <div style="padding: 24px; padding-bottom: 0;">
          <h1 style="margin: 0 0 8px 0; font-size: 1.8rem; font-weight: 800;">Dashboard Settings</h1>
          <p style="margin: 0; opacity: 0.7; font-size: 1rem;">Fine-tune your main activity views.</p>
        </div>
        <div class="card-content">
          <mat-form-field appearance="outline">
            <mat-label>Start of the Week</mat-label>
            <mat-select formControlName="startOfTheWeek">
              <mat-option [value]="0">Sunday</mat-option>
              <mat-option [value]="1">Monday</mat-option>
              <mat-option [value]="2">Tuesday</mat-option>
              <mat-option [value]="3">Wednesday</mat-option>
              <mat-option [value]="4">Thursday</mat-option>
              <mat-option [value]="5">Friday</mat-option>
              <mat-option [value]="6">Saturday</mat-option>
            </mat-select>
            <mat-hint>Week starts on this day in your calendars</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Activities per Page</mat-label>
            <mat-select formControlName="eventsPerPage">
              @for (option of eventsPerPage; track option) {
              <mat-option [value]="option">{{option}}</mat-option>
              }
            </mat-select>
            <mat-hint>Adjust how many records are loaded at once for better performance.</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Exclude Elevation for Sport Types</mat-label>
            <mat-select formControlName="removeAscentForActivitiesSummaries" multiple>
              @for (type of activityTypes; track type) {
              <mat-option [value]="type">{{type}}</mat-option>
              }
            </mat-select>
            <mat-hint>Elevation data will be hidden for these activities in summaries.</mat-hint>
          </mat-form-field>
        </div>
      </mat-card>
      }

      <!-- Map Settings -->
      @if (activeSection === 'map') {
      <mat-card class="settings-card glass-card">
        <div style="padding: 24px; padding-bottom: 0;">
          <h1 style="margin: 0 0 8px 0; font-size: 1.8rem; font-weight: 800;">Map Settings</h1>
          <p style="margin: 0; opacity: 0.7; font-size: 1rem;">Configure how your activities are drawn.</p>
        </div>
        <div class="card-content">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <mat-form-field appearance="outline">
              <mat-label>Map Appearance</mat-label>
              <mat-select formControlName="mapTheme">
                @for (theme of mapThemes | keyvalue; track theme) {
                <mat-option [value]="theme.value">{{theme.key}}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Map Layer (Default)</mat-label>
              <mat-select formControlName="mapType">
                @for (type of mapTypes | keyvalue; track type) {
                <mat-option [value]="type.value">{{type.key}}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Lap Markers</mat-label>
            <mat-select formControlName="mapLapTypes" multiple>
              @for (lapType of lapTypes; track lapType) {
              <mat-option [value]="lapType">{{lapType}}</mat-option>
              }
            </mat-select>
            <mat-hint>Select which markers to display on your activity routes.</mat-hint>
          </mat-form-field>

          <div style="display: flex; flex-direction: column; gap: 16px; margin: 8px 0;">
            <mat-slide-toggle formControlName="showMapLaps">Enable Auto-Laps</mat-slide-toggle>
            <mat-slide-toggle formControlName="showMapArrows">Show Directional Arrows</mat-slide-toggle>
            <mat-slide-toggle formControlName="showMapPoints">Show GPS Data Points</mat-slide-toggle>
          </div>

          <div style="margin-top: 16px;">
            <p style="margin: 0 0 8px 0; font-size: 0.9rem; font-weight: 500;">Route Line Width</p>
            <mat-slider [max]="10" [min]="0.5" [step]="0.5" discrete style="width: 100%;">
              <input matSliderThumb formControlName="mapStrokeWidth">
            </mat-slider>
          </div>
        </div>
      </mat-card>
      }

      <!-- Chart Settings -->
      @if (activeSection === 'charts') {
      <mat-card class="settings-card glass-card">
        <div style="padding: 24px; padding-bottom: 0;">
          <h1 style="margin: 0 0 8px 0; font-size: 1.8rem; font-weight: 800;">Chart Settings</h1>
          <p style="margin: 0; opacity: 0.7; font-size: 1rem;">Customize data visualization and analysis.</p>
        </div>
        <div class="card-content">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <mat-form-field appearance="outline">
              <mat-label>Data Scaling (X-Axis)</mat-label>
              <mat-select formControlName="xAxisType">
                @for (x of xAxisTypes | keyvalue; track x) {
                <mat-option [value]="x.value">{{x.key}}</mat-option>
                }
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Chart Aesthetics</mat-label>
              <mat-select formControlName="chartTheme">
                @for (t of chartThemes | keyvalue; track t) {
                <mat-option [value]="t.value">{{t.key}}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline">
            <mat-label>Visible Metrics</mat-label>
            <mat-select formControlName="dataTypesToUse" multiple>
              @for (group of dataGroups; track group.name) {
              <mat-optgroup [label]="group.name">
                @for (data of group.data; track $index) {
                <mat-option [value]="data">{{data}}</mat-option>
                }
              </mat-optgroup>
              }
            </mat-select>
            <mat-hint>Select which data series are plotted by default.</mat-hint>
          </mat-form-field>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 8px 0;">
            <mat-slide-toggle formControlName="showAllData">Show All Data Points</mat-slide-toggle>
            <mat-slide-toggle formControlName="chartCursorBehaviour">Selection Tool by Default</mat-slide-toggle>
            <mat-slide-toggle formControlName="useAnimations">Enable Animations</mat-slide-toggle>
            <mat-slide-toggle formControlName="stackYAxes">Stack Multi-Charts</mat-slide-toggle>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 16px;">
            <div>
              <p style="margin: 0 0 8px 0; font-size: 0.9rem; font-weight: 500;">Line Width</p>
              <mat-slider [max]="10" [min]="0.5" [step]="0.5" discrete style="width: 100%;">
                <input matSliderThumb formControlName="chartStrokeWidth">
              </mat-slider>
            </div>
            <div>
              <p style="margin: 0 0 8px 0; font-size: 0.9rem; font-weight: 500;">Fill Intensity</p>
              <mat-slider [max]="1" [min]="0" [step]="0.1" discrete style="width: 100%;">
                <input matSliderThumb formControlName="chartFillOpacity">
              </mat-slider>
            </div>
          </div>
        </div>
      </mat-card>
      }

      <!-- Unit Settings -->
      @if (activeSection === 'units') {
      <mat-card class="settings-card glass-card">
        <div style="padding: 24px; padding-bottom: 0;">
          <h1 style="margin: 0 0 8px 0; font-size: 1.8rem; font-weight: 800;">Measurement Units</h1>
          <p style="margin: 0; opacity: 0.7; font-size: 1rem;">Choose your preferred units for sporting data.</p>
        </div>
        <div class="card-content">
          <mat-form-field appearance="outline">
            <mat-label>Preferred Speed Units</mat-label>
            <mat-select formControlName="speedUnitsToUse" multiple>
              @for (unit of speedUnits | keyvalue; track unit.key) {
              <mat-option [value]="unit.value">{{unit.value}}</mat-option>
              }
            </mat-select>
            <mat-hint>Metrics used for running, cycling, etc.</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Preferred Pace Units</mat-label>
            <mat-select formControlName="paceUnitsToUse" multiple>
              @for (unit of paceUnits | keyvalue; track unit.key) {
              <mat-option [value]="unit.value">{{unit.value}}</mat-option>
              }
            </mat-select>
            <mat-hint>Time per kilometer or mile calculations.</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Swim Pace Preference</mat-label>
            <mat-select formControlName="swimPaceUnitsToUse" multiple>
              @for (unit of swimPaceUnits | keyvalue; track unit.key) {
              <mat-option [value]="unit.value">{{unit.value}}</mat-option>
              }
            </mat-select>
            <mat-hint>Specific units for swimming segments.</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Vertical Speed Preference</mat-label>
            <mat-select formControlName="verticalSpeedUnitsToUse" multiple>
              @for (unit of verticalSpeedUnits | keyvalue; track unit.key) {
              <mat-option [value]="unit.value">{{unit.value}}</mat-option>
              }
            </mat-select>
            <mat-hint>Climbing and descent rate indicators.</mat-hint>
          </mat-form-field>
        </div>
      </mat-card>
      }

      <!-- Floating Action Button for Save (Desktop Only) -->
      @if (!hasError()) {
      <div class="qs-form-actions-floating">
        <button mat-fab color="primary" [disabled]="isSaving || !userSettingsFormGroup.dirty" matTooltip="Save Changes"
          (click)="onSubmit($event)">
          <mat-icon>save</mat-icon>
        </button>
      </div>
      }

      <!-- Sticky Save for Mobile -->
      @if (!hasError()) {
      <div class="mobile-save-bar">
        <button mat-flat-button color="primary" [disabled]="isSaving || !userSettingsFormGroup.dirty"
          (click)="onSubmit($event)">
          Save Settings
        </button>
      </div>
      }

    </form>

    <app-shade [isActive]="isSaving || isDeleting" [hasError]="errorSaving || errorDeleting"
      [errorMessage]="errorSaving || errorDeleting"></app-shade>
  </main>
</div>