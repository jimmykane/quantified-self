<div class="pricing-container">
  <h1>{{ currentRole === 'pro' ? 'Your Subscription' : 'Choose Your Plan' }}</h1>

  <div *ngIf="!currentRole || currentRole === 'free'" class="restore-section">
    <div class="restore-alert">
      <p>Already have an active subscription?</p>
      <button mat-stroked-button color="accent" (click)="restorePurchases()" [disabled]="isLoading">
        @if (isLoading) {
        <mat-spinner diameter="20"></mat-spinner>
        } @else {
        Restore Access
        }
      </button>
    </div>
  </div>

  @if (currentRole === 'pro') {
  <div class="manage-subscription-container">
    <mat-card class="product-card">
      <mat-card-header>
        <mat-card-title>Pro Membership</mat-card-title>
        <mat-card-subtitle>Active & Verified</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="manage-content">
        <p>Thank you for being a pro member. You have full access to all features.</p>
        <div class="price-section">
          <button mat-flat-button color="primary" (click)="manageSubscription()" [disabled]="isLoading">
            @if (isLoading) {
            <mat-spinner diameter="20"></mat-spinner>
            } @else {
            Manage Subscription
            }
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  } @else {
  <div class="products-grid" *ngIf="products$ | async as products; else loading">
    @for (product of products; track product.id) {
    <mat-card class="product-card" [class.current-plan]="product.metadata.role === currentRole">
      <mat-card-header>
        <mat-card-title>
          {{ product.name }}
        </mat-card-title>
        <mat-card-subtitle>{{ product.description }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div style="flex-grow: 1;"></div>
        <!-- Since we split into virtual products, each product has exactly 1 price usually -->
        <div *ngFor="let price of product.prices" class="price-section">
          <h3 class="price">
            {{ (price.unit_amount || 0) / 100 | currency: price.currency.toUpperCase() }}
            <span *ngIf="price.recurring">/ {{ price.recurring.interval }}</span>
          </h3>

          <!-- Current Plan Indicator -->
          @if (currentRole && product.metadata.role === currentRole) {
          <button mat-stroked-button disabled class="current-plan-btn">Current Plan</button>
          }

          <!-- Manage/Downgrade for Pro Users looking at Basic -->
          @else if (currentRole === 'pro' && product.metadata.role === 'basic') {
          <button mat-stroked-button (click)="manageSubscription()" [disabled]="isLoading">Downgrade</button>
          }

          <!-- Upgrade/Buy Logic -->
          @else {
          <!-- Use 'Upgrade' if we are Basic looking at Pro -->
          @if (currentRole === 'basic' && product.metadata.role === 'pro') {
          <button mat-flat-button color="accent" (click)="subscribe(price)" [disabled]="isLoading">Upgrade</button>
          }
          <!-- Otherwise 'Subscribe' (for new users or Free users upgrading to anything) -->
          @else {
          <button mat-flat-button color="primary" (click)="subscribe(price)" [disabled]="isLoading">
            @if (loadingPriceId === price.id) {
            <mat-spinner diameter="20"></mat-spinner>
            } @else {
            {{ price.recurring ? 'Subscribe' : 'Buy Now' }}
            }
          </button>
          }
          }

        </div>
      </mat-card-content>
    </mat-card>
    }
  </div>
  <ng-template #loading>
    <div class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading plans...</p>
    </div>
  </ng-template>
  }
</div>