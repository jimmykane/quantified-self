<div class="pricing-container">
  @if (isLoadingRole) {
  <div class="loading-state">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Verifying subscription...</p>
  </div>
  } @else {
  <h1>{{ currentRole === 'pro' ? 'Your Subscription' : 'Choose Your Plan' }}</h1>

  <div *ngIf="!currentRole || currentRole === 'free'" class="restore-section">
    <div class="restore-alert">
      <p>Already have an active subscription?</p>
      <button mat-stroked-button color="accent" (click)="restorePurchases()" [disabled]="isLoading">
        @if (isLoading) {
        <mat-spinner diameter="20"></mat-spinner>
        } @else {
        Restore Access
        }
      </button>
    </div>
  </div>

  @if (currentRole === 'pro') {
  <div class="manage-subscription-container">
    <mat-card class="product-card">
      <mat-card-header>
        <mat-card-title>Pro Membership</mat-card-title>
        <mat-card-subtitle>Active & Verified</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="manage-content">
        <p>Thank you for being a pro member. You have full access to all features.</p>
        <div class="price-section">
          <button mat-flat-button color="primary" (click)="manageSubscription()" [disabled]="isLoading">
            @if (isLoading) {
            <mat-spinner diameter="20"></mat-spinner>
            } @else {
            Manage Subscription
            }
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  } @else {
  <div class="products-grid" *ngIf="products$ | async as products; else loading">
    @for (product of products; track product.id) {
    <mat-card class="product-card glass-card"
      [class.current-plan-highlight]="(product.metadata.role === 'free' && (!currentRole || currentRole === 'free')) || product.metadata.role === currentRole"
      [class.pro-card]="product.metadata.role === 'pro'" [class.basic-card]="product.metadata.role === 'basic'"
      [class.free-card]="product.metadata.role === 'free'">

      @if (product.metadata.role === 'pro') {
      <div class="popular-ribbon pro-ribbon">Best Value</div>
      }

      <mat-card-header>
        <mat-card-title>
          {{ product.name }}
        </mat-card-title>
        <mat-card-subtitle>{{ product.description }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="features-list">
          @if (product.metadata.role === 'free') {
          <ul>
            <li><mat-icon style="color: grey">check</mat-icon> Manual uploads</li>
            <li><mat-icon style="color: grey">check</mat-icon> Basic analysis</li>
            <li><mat-icon color="warn">close</mat-icon> No auto-sync</li>
          </ul>
          } @else if (product.metadata.role === 'basic') {
          <ul>
            <li><mat-icon color="accent">check</mat-icon> Track up to 100 activities</li>
            <li><mat-icon color="warn">close</mat-icon> Manual uploads only</li>
            <li><mat-icon color="primary">dns</mat-icon> Help keep the project running</li>
          </ul>
          } @else if (product.metadata.role === 'pro') {
          <ul>
            <li><mat-icon color="primary">check_circle</mat-icon> <strong>No limits</strong>, ever</li>
            <li><mat-icon color="primary">check_circle</mat-icon> Auto-sync from your watch</li>
            <li><mat-icon color="warn">favorite</mat-icon> Power the next big update</li>
          </ul>
          }
        </div>


        <div style="flex-grow: 1;"></div>
        <!-- Since we split into virtual products, each product has exactly 1 price usually -->
        <div *ngFor="let price of product.prices" class="price-section">
          <h3 class="price">
            @if (price.unit_amount === 0) {
            $0
            } @else {
            {{ (price.unit_amount || 0) / 100 | currency: price.currency.toUpperCase() : 'symbol' : '1.0-0' }}
            }
            <span *ngIf="price.recurring" class="interval">/ {{ price.recurring.interval }}</span>
          </h3>

          <!-- Current Plan Indicator -->
          @if ((product.metadata.role === 'free' && (!currentRole || currentRole === 'free')) || (currentRole &&
          product.metadata.role === currentRole)) {
          <div class="current-plan-chip">
            <mat-chip-row highlighted color="primary" class="current-plan-indicator"
              [style.backgroundColor]="product.metadata.role === 'free' ? 'grey' : null"
              [style.color]="product.metadata.role === 'free' ? 'white' : null">
              <mat-icon matChipAvatar>check_circle</mat-icon>
              Current Plan
            </mat-chip-row>
          </div>
          }

          <!-- Manage/Downgrade for Pro Users looking at Basic -->
          @else if (currentRole === 'pro' && product.metadata.role === 'basic') {
          <button mat-stroked-button (click)="manageSubscription()" [disabled]="isLoading">Downgrade</button>
          }

          <!-- Upgrade/Buy/Select Free Logic -->
          @else {
          @if (product.metadata.role === 'free') {
          @if (currentRole) {
          <!-- Paid user looking at free -->
          <button mat-stroked-button disabled>Included</button>
          } @else {
          <!-- New User (Role is null) choosing Free -->
          <button mat-stroked-button (click)="selectFreeTier()" [disabled]="isLoading">
            Choose Free Tier
          </button>
          }
          } @else {
          <!-- Use 'Upgrade' if we are Basic looking at Pro -->
          @if (currentRole === 'basic' && product.metadata.role === 'pro') {
          <button mat-flat-button color="accent" (click)="subscribe(price)" [disabled]="isLoading" class="upgrade-btn">
            @if (loadingPriceId === price.id) {
            <mat-spinner diameter="20"></mat-spinner>
            } @else {
            Upgrade to Pro
            }
          </button>
          }
          <!-- Otherwise 'Subscribe' (for new users or Free users upgrading to anything) -->
          @else {
          <button mat-flat-button color="primary" (click)="subscribe(price)" [disabled]="isLoading"
            class="subscribe-btn">
            @if (loadingPriceId === price.id) {
            <mat-spinner diameter="20"></mat-spinner>
            } @else {
            {{ price.recurring ? (product.metadata.role | titlecase) : 'Buy Now' }}
            }
          </button>
          }
          }
          }

        </div>
      </mat-card-content>
    </mat-card>
    }
  </div>
  <ng-template #loading>
    <div class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading plans...</p>
    </div>
  </ng-template>
  }
  }
</div>