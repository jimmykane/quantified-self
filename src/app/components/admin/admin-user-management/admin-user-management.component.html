<div class="admin-container">
    <div class="header-container">
        <div class="header-content">
            <button mat-icon-button routerLink="/admin" matTooltip="Back to Dashboard">
                <mat-icon>arrow_back</mat-icon>
            </button>
            <div>
                <h1 class="app-text-gradient">User Management</h1>
                <p class="premium-subtitle">Search and manage user accounts</p>
            </div>
        </div>
    </div>

    <div class="dashboard-section">
        <div class="section-title">
            <h2>
                <mat-icon>people</mat-icon>
                User Management
            </h2>
        </div>

        <!-- User Stats -->
        <div class="stats-grid" style="margin-bottom: 24px;">
            <!-- Total Users -->
            <div class="glass-card app-stat-card users">
                <div class="app-stat-header">
                    <mat-icon>people</mat-icon>
                    <span>Total Users</span>
                </div>
                <div class="app-stat-value" *ngIf="userStats">{{ userStats.total }}</div>
                <div class="app-spinner-mini" *ngIf="!userStats">
                    <mat-spinner diameter="24"></mat-spinner>
                </div>
            </div>

            <!-- Pro Users -->
            <div class="glass-card app-stat-card status-success">
                <div class="app-stat-header">
                    <mat-icon>verified</mat-icon>
                    <span>Pro Users</span>
                </div>
                <div class="app-stat-value" *ngIf="userStats">{{ userStats.pro }}</div>
                <div class="app-spinner-mini" *ngIf="!userStats">
                    <mat-spinner diameter="24"></mat-spinner>
                </div>
            </div>

            <!-- Basic Users -->
            <div class="glass-card app-stat-card status-pending">
                <div class="app-stat-header">
                    <mat-icon>person_outline</mat-icon>
                    <span>Basic Users</span>
                </div>
                <div class="app-stat-value" *ngIf="userStats">{{ userStats.basic }}</div>
                <div class="app-spinner-mini" *ngIf="!userStats">
                    <mat-spinner diameter="24"></mat-spinner>
                </div>
            </div>

            <!-- Free Users -->
            <div class="glass-card app-stat-card">
                <div class="app-stat-header">
                    <mat-icon>money_off</mat-icon>
                    <span>Free Users</span>
                </div>
                <div class="app-stat-value" *ngIf="userStats" style="opacity: 0.7;">{{ userStats.free }}</div>
                <div class="app-spinner-mini" *ngIf="!userStats">
                    <mat-spinner diameter="24"></mat-spinner>
                </div>
            </div>
        </div>

        <!-- Auth Provider Breakdown Chart -->
        <div class="glass-card" style="margin-bottom: 24px;">
            <h3 class="chart-header">
                <mat-icon style="margin-right: 8px; vertical-align: middle;">security</mat-icon>
                Auth Provider Breakdown
            </h3>

            <div class="chart-wrapper" style="height: 220px; padding: 16px;">
                <canvas baseChart [data]="authPieChartData" [options]="authPieChartOptions" [type]="'pie'">
                </canvas>
            </div>

            <div *ngIf="!userStats?.providers" class="empty-state" style="padding: 0 24px 24px;">
                No provider data available
            </div>
        </div>

        <div class="glass-card qs-filter-container">
            <mat-form-field appearance="outline" class="qs-search-field" subscriptSizing="dynamic">
                <mat-label>Search users</mat-label>
                <input matInput [value]="searchTerm" (input)="onSearchInput($event)"
                    placeholder="Search by email, name, or UID">
                <mat-icon matSuffix *ngIf="!searchTerm">search</mat-icon>
                <button mat-icon-button matSuffix *ngIf="searchTerm" (click)="clearSearch()" aria-label="Clear">
                    <mat-icon>close</mat-icon>
                </button>
            </mat-form-field>

            <mat-form-field appearance="outline" class="qs-filter-field" style="max-width: 200px;"
                subscriptSizing="dynamic">
                <mat-label>Filter Service</mat-label>
                <mat-select [value]="filterService" (selectionChange)="onFilterServiceChange($event.value)">
                    <mat-option [value]="undefined">All Services</mat-option>
                    <mat-option value="garmin">Garmin</mat-option>
                    <mat-option value="suunto">Suunto</mat-option>
                    <mat-option value="coros">Coros</mat-option>
                </mat-select>
            </mat-form-field>
        </div>

        <div class="glass-card table-container">
            <div class="loading-shade" *ngIf="isLoading">
                <mat-spinner></mat-spinner>
            </div>

            <div class="error-message" *ngIf="error">
                {{ error }}
            </div>

            <div class="table-wrapper">
                <table mat-table [dataSource]="users" matSort (matSortChange)="onSortChange($event)">

                    <!-- Photo Column -->
                    <ng-container matColumnDef="photoURL">
                        <th mat-header-cell *matHeaderCellDef></th>
                        <td mat-cell *matCellDef="let user">
                            <img [src]="user.photoURL || 'assets/icons/user.svg'" class="user-avatar" alt="Avatar"
                                referrerpolicy="no-referrer"
                                (error)="$any($event.target).src = 'assets/icons/user.svg'">
                        </td>
                    </ng-container>

                    <!-- Email Column -->
                    <ng-container matColumnDef="email">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Email </th>
                        <td mat-cell *matCellDef="let user"> {{user.email}} </td>
                    </ng-container>

                    <!-- Providers Column -->
                    <ng-container matColumnDef="providerIds">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Auth </th>
                        <td mat-cell *matCellDef="let user">
                            <div class="provider-icons">
                                <ng-container *ngFor="let provider of user.providerIds">
                                    <mat-icon *ngIf="provider === 'google.com'" matTooltip="Google"
                                        class="provider-google">public</mat-icon>
                                    <mat-icon *ngIf="provider === 'password'" matTooltip="Email/Password"
                                        class="provider-email">email</mat-icon>
                                    <mat-icon *ngIf="provider === 'apple.com'" matTooltip="Apple"
                                        class="provider-apple">apple</mat-icon>
                                    <mat-icon *ngIf="provider === 'facebook.com'" matTooltip="Facebook"
                                        class="provider-facebook">facebook</mat-icon>
                                    <mat-icon
                                        *ngIf="provider !== 'google.com' && provider !== 'password' && provider !== 'apple.com' && provider !== 'facebook.com'"
                                        [matTooltip]="provider">person</mat-icon>
                                </ng-container>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Display Name Column -->
                    <ng-container matColumnDef="displayName">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Name </th>
                        <td mat-cell *matCellDef="let user"> {{user.displayName || '-'}} </td>
                    </ng-container>

                    <!-- Role Column -->
                    <ng-container matColumnDef="role">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Role </th>
                        <td mat-cell *matCellDef="let user">
                            <span class="role-badge" [ngClass]="getRole(user)">
                                {{getRole(user) | uppercase}}
                            </span>
                        </td>
                    </ng-container>

                    <!-- Subscription Column -->
                    <ng-container matColumnDef="subscription">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Subscription </th>
                        <td mat-cell *matCellDef="let user">
                            {{ getSubscriptionDetails(user) }}
                            <a *ngIf="user.subscription?.stripeLink" [href]="user.subscription.stripeLink"
                                target="_blank" mat-icon-button color="primary" matTooltip="View in Stripe">
                                <mat-icon>open_in_new</mat-icon>
                            </a>
                        </td>
                    </ng-container>

                    <!-- Services Column -->
                    <ng-container matColumnDef="services">
                        <th mat-header-cell *matHeaderCellDef> Services </th>
                        <td mat-cell *matCellDef="let user">
                            <div style="display: flex; flex-direction: column; gap: 4px; padding: 4px 0;">
                                <ng-container *ngFor="let service of user.connectedServices">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <img [src]="getServiceLogo(service.provider)" [alt]="service.provider"
                                            style="height: 18px; width: 18px;">
                                        <span class="text-detail-date">
                                            {{ formatConnectionDate(service.connectedAt) }}
                                        </span>
                                    </div>
                                </ng-container>
                                <span *ngIf="!user.connectedServices?.length" class="text-detail-muted">-</span>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Created Column -->
                    <ng-container matColumnDef="created">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Created </th>
                        <td mat-cell *matCellDef="let user"> {{user.metadata.creationTime | date:'shortDate'}} </td>
                    </ng-container>

                    <!-- Last Login Column -->
                    <ng-container matColumnDef="lastLogin">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Last Login </th>
                        <td mat-cell *matCellDef="let user"> {{user.metadata.lastSignInTime | date:'short'}} </td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
                        <td mat-cell *matCellDef="let user">
                            <span class="status-badge" [ngClass]="user.disabled ? 'disabled' : 'active'">
                                {{user.disabled ? 'Disabled' : 'Active'}}
                            </span>
                        </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef> Actions </th>
                        <td mat-cell *matCellDef="let user">
                            <button mat-icon-button color="primary" matTooltip="Impersonate User"
                                (click)="onImpersonate(user)" *ngIf="!isAdmin(user)">
                                <mat-icon>supervised_user_circle</mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                    <!-- Row shown when there is no matching data. -->
                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell" colspan="10">
                            <span *ngIf="searchTerm">No users found matching "{{searchTerm}}"</span>
                            <span *ngIf="!searchTerm && !isLoading">No users found</span>
                        </td>
                    </tr>
                </table>
            </div>

            <mat-paginator [length]="totalCount" [pageIndex]="currentPage" [pageSize]="pageSize"
                [pageSizeOptions]="pageSizeOptions" (page)="onPageChange($event)" aria-label="Select page of users">
            </mat-paginator>
        </div>
    </div>
</div>