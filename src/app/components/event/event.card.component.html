<div class="event-dashboard-container">


  @if (event) {
  <!-- 1. HEADER SECTION (Sticky / Summary) -->
  <mat-card class="dashboard-card header-section glass-card">
    <app-event-header [event]="event" [user]='currentUser' [isOwner]="currentUser && (currentUser.uid === targetUserID)"
      [selectedActivities]="selectedActivities" [unitSettings]="userUnitSettings" [statsToShow]="basicStatsTypes">
    </app-event-header>

    <mat-divider></mat-divider>

    <app-event-card-stats-grid [event]="event" [selectedActivities]="selectedActivities"
      [unitSettings]="userUnitSettings">
    </app-event-card-stats-grid>

    @if (event.getActivities().length > 1) {
    <mat-divider></mat-divider>
    <app-activities-toggles [event]="event" [user]="currentUser" [isOwner]="isOwner()">
    </app-activities-toggles>
    }
  </mat-card>

  <app-event-header [isOwner]="isOwner()" [event]="event" [user]="currentUser">
  </app-event-header>

  <mat-card class="header-section glass-card dashboard-card">
    <app-event-card-stats-grid [event]="event" [selectedActivities]="selectedActivities"
      [unitSettings]="userUnitSettings">
    </app-event-card-stats-grid>
  </mat-card>

  <!-- 2. TABS SECTION -->
  <div class="secondary-details-container glass-card dashboard-card">
    <!-- Unified Horizontal Navigation (Chip Style) -->
    <nav class="settings-nav">
      <ul class="nav-list">
        <li class="nav-item" [class.active]="activeSection === 'overview'" (click)="activeSection = 'overview'">
          <mat-icon>dashboard</mat-icon> Overview
        </li>
        @if (hasLaps(event)) {
        <li class="nav-item" [class.active]="activeSection === 'laps'" (click)="activeSection = 'laps'">
          <mat-icon>timer</mat-icon> Laps
        </li>
        }
        <li class="nav-item" [class.active]="activeSection === 'analysis'" (click)="activeSection = 'analysis'">
          <mat-icon>analytics</mat-icon> Analysis
        </li>
        @if (hasIntensityZones(event) || hasDevices(event)) {
        <li class="nav-item" [class.active]="activeSection === 'details'" (click)="activeSection = 'details'">
          <mat-icon>info</mat-icon> Details
        </li>
        }
      </ul>
    </nav>

    <div class="tab-content-container">
      <!-- SECTION: OVERVIEW (Default) -->
      @if (activeSection === 'overview') {
      <div class="tab-content-wrapper responsive-grid">
        <!-- Map Section -->
        @if (event && targetUserID && hasPositions(event)) {
        <mat-card class="dashboard-card map-section glass-card no-shadow">
          <app-event-card-map [selectedActivities]="selectedActivities" [targetUserID]="targetUserID"
            [user]="currentUser" [event]="event" [showLaps]="showMapLaps" [showPoints]="showMapPoints"
            [lapTypes]="mapLapTypes" [showArrows]="showMapArrows" [strokeWidth]="mapStrokeWidth" [theme]="mapTheme">
          </app-event-card-map>
        </mat-card>
        }

        <!-- Chart Section -->
        @if (event && targetUserID && currentUser) {
        <mat-card class="dashboard-card chart-section glass-card no-shadow">
          <app-event-card-chart [showAllData]="showAllData" [showLaps]="showChartLaps"
            [useAnimations]="useChartAnimations" [disableGrouping]="chartDisableGrouping"
            [hideAllSeriesOnInit]="chartHideAllSeriesOnInit" [gainAndLossThreshold]="chartGainAndLossThreshold"
            [stackYAxes]="stackChartYAxes" [showGrid]="showChartGrid" [lapTypes]="chartLapTypes"
            [xAxisType]="chartXAxisType" [strokeWidth]="chartStrokeWidth" [strokeOpacity]="chartStrokeOpacity"
            [extraMaxForPower]="chartExtraMaxForPower" [extraMaxForPace]="chartExtraMaxForPace"
            [fillOpacity]="chartFillOpacity" [selectedActivities]="selectedActivities" [targetUserID]="targetUserID"
            [dataTypesToUse]="chartDataTypesToUse" [userUnitSettings]="userUnitSettings" [user]="currentUser"
            [downSamplingLevel]="chartDownSamplingLevel" [chartCursorBehaviour]="chartCursorBehaviour"
            [chartTheme]="chartTheme" [waterMark]="currentUser ? currentUser.brandText : null" [event]="event">
          </app-event-card-chart>
        </mat-card>
        }
      </div>
      }

      <!-- SECTION: LAPS -->
      @if (activeSection === 'laps' && hasLaps(event)) {
      <div class="tab-content-wrapper">
        <app-event-card-laps [selectedActivities]="selectedActivities" [unitSettings]="userUnitSettings"
          [event]="event">
        </app-event-card-laps>
      </div>
      }

      <!-- SECTION: ANALYSIS -->
      @if (activeSection === 'analysis') {
      <div class="tab-content-wrapper">
        <app-event-stats-table [selectedActivities]="selectedActivities" [userUnitSettings]="userUnitSettings"
          [event]="event">
        </app-event-stats-table>
      </div>
      }

      <!-- SECTION: DETAILS -->
      @if (activeSection === 'details' && (hasIntensityZones(event) || hasDevices(event))) {
      <div class="tab-content-wrapper">
        @if (hasIntensityZones(event)) {
        <app-event-intensity-zones [activities]="selectedActivities" [useAnimations]="useChartAnimations"
          [chartTheme]="chartTheme">
        </app-event-intensity-zones>
        }

        @if (hasDevices(event)) {
        @if (hasIntensityZones(event)) { <mat-divider></mat-divider> }
        <app-event-card-devices [selectedActivities]="selectedActivities" [event]="event">
        </app-event-card-devices>
        }
      </div>
      }
    </div>
  </div>
  }
</div>