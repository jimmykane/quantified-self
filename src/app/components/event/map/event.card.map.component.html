<div class="map-component-wrapper">
  <div class="map-header">
    <div class="map-header-avatar">
      <mat-icon>map</mat-icon>
    </div>
    <div class="map-header-actions">
      <app-map-actions [showLaps]="showLaps" [showArrows]="showArrows" [user]="user"
        (showLapsChange)="onShowLapsChange($event)" (showArrowsChange)="onShowArrowsChange($event)">
      </app-map-actions>
    </div>
  </div>
  <section class="container">
    @if (googleMap && event.getActivities().length > 1) {
    <mat-card class="map-legend mat-elevation-z0">
      @for (activity of event.getActivities(); track activity.getID()) {
      <app-activity-toggle [activity]="activity" [event]="event" [showActions]="false" [showToggle]="false"
        [showStats]="false" [showDate]="false" [selectedActivities]="selectedActivities">
      </app-activity-toggle>
      }
    </mat-card>
    }
    <app-shade [isActive]="isLoading" [hasError]="noMapData" errorMessage="No Map Data"></app-shade>

    <!-- Placeholder when no data -->
    @if (activitiesMapData.length === 0) {
    <section class="placeholder"></section>
    }

    <!-- Google Map -->
    @defer (on viewport) {
    @if (activitiesMapData.length > 0 && apiLoaded()) {
    <google-map height="100%" width="100%" [center]="mapCenter()" [zoom]="mapZoom()" [mapTypeId]="mapTypeId()"
      [options]="mapOptions()" (mapInitialized)="onMapReady($event)" (zoomChanged)="onZoomChanged()"
      (centerChanged)="onCenterChanged()">
      @for (activityMapData of activitiesMapData; track activityMapData.activity.getID()) {
      <!-- Start Marker -->
      @if (activityMapData.positions.length > 0) {
      <map-advanced-marker
        [position]="{lat: activityMapData.positions[0].latitudeDegrees, lng: activityMapData.positions[0].longitudeDegrees}"
        [options]="getHomeMarkerOptions(activityMapData.activity, activityMapData.strokeColor)">
      </map-advanced-marker>
      }
      <!-- Cursor Marker -->
      @if (activitiesCursors.get(activityMapData.activity.getID())) {
      <map-advanced-marker
        [position]="{lat: activitiesCursors.get(activityMapData.activity.getID()).latitudeDegrees, lng: activitiesCursors.get(activityMapData.activity.getID()).longitudeDegrees}"
        [options]="getCursorMarkerOptions(activityMapData.activity, activityMapData.strokeColor)">
      </map-advanced-marker>
      }
      <!-- Activity Polyline -->
      <map-polyline [path]="getPolylinePath(activityMapData)" [options]="getPolylineOptions(activityMapData)"
        (polylineClick)="onPolylineClick($event, activityMapData)">
      </map-polyline>
      <!-- End Marker -->
      @if (activityMapData.positions.length > 0) {
      <map-advanced-marker
        [position]="{lat: activityMapData.positions[activityMapData.positions.length - 1].latitudeDegrees, lng: activityMapData.positions[activityMapData.positions.length - 1].longitudeDegrees}"
        [options]="getFlagMarkerOptions(activityMapData.activity, activityMapData.strokeColor)">
      </map-advanced-marker>
      }
      <!-- Lap Markers -->
      @for (lap of activityMapData.laps; track lap.lap.startDate.getTime(); let i = $index) {
      <map-advanced-marker [position]="{lat: lap.lapPosition.latitudeDegrees, lng: lap.lapPosition.longitudeDegrees}"
        [options]="getLapMarkerOptions(activityMapData.activity, activityMapData.strokeColor, i)">
      </map-advanced-marker>
      }
      <!-- Point Markers (optional) -->
      @if (showPoints) {
      @for (position of activityMapData.positions; track position.time) {
      <map-advanced-marker [position]="{lat: position.latitudeDegrees, lng: position.longitudeDegrees}"
        [content]="pointMarkerContent(activityMapData.strokeColor)">
      </map-advanced-marker>
      }
      }
      }
    </google-map>
    }
    } @placeholder {
    <div
      style="height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.05);">
      <p>Loading map...</p>
    </div>
    }
  </section>
</div>