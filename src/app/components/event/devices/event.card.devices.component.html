@for (activity of selectedActivities; track activity) {
<div class="activity-devices-section">
  <app-activity-toggle [event]="event" [showToggle]="false" [showDate]="false" [showStats]="false" [activity]="activity"
    [selectedActivities]="selectedActivities">
  </app-activity-toggle>

  @if (getDeviceGroups(activity).length > 0) {
  <mat-accordion class="device-accordion" multi>
    @for (group of getDeviceGroups(activity); track group.signature) {
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon class="category-icon">{{ getCategoryIcon(group.category) }}</mat-icon>
          <span class="device-name">{{ group.displayName }}</span>
        </mat-panel-title>
        <mat-panel-description>
          @if (group.batteryLevel !== null || group.batteryStatus) {
          <div class="battery-indicator" [ngClass]="getBatteryColorClass(group.batteryLevel, group.batteryStatus)">
            <mat-icon>{{ getBatteryIcon(group.batteryLevel, group.batteryStatus) }}</mat-icon>
            @if (group.batteryLevel !== null) {
            <span>{{ group.batteryLevel }}%</span>
            } @else {
            <!-- Map 'New' to 'Full' for clarity, otherwise show status -->
            <span>{{ group.batteryStatus === 'New' ? 'Full' : group.batteryStatus }}</span>
            }
          </div>
          }
        </mat-panel-description>
      </mat-expansion-panel-header>

      <div class="device-details">
        @for (entry of getDetailEntries(group); track entry.label) {
        <div class="detail-item">
          <mat-icon class="detail-icon">{{ entry.icon }}</mat-icon>
          <div class="detail-content">
            <span class="detail-label">{{ entry.label }}</span>
            <span class="detail-value">{{ entry.value }}</span>
          </div>
        </div>
        }
        @if (getDetailEntries(group).length === 0) {
        <div class="no-details">
          <mat-icon>info</mat-icon>
          <p>No additional technical details reported for this device.</p>
        </div>
        }
      </div>
    </mat-expansion-panel>
    }
  </mat-accordion>
  } @else {
  <p class="no-devices">No device information available.</p>
  }
</div>
@if (!$last) {
<mat-divider [inset]="true"></mat-divider>
}
}