<mat-card class="mat-elevation-z0 service-card">
  <mat-card-content>
    <p class="description-text">
      Suunto is a trusted companion for athletes and adventurers. The durable and precise sports watches are tested in
      the toughest conditions and built to last in adventures from the deepest oceans to the highest mountains.
    </p>

    <div class="service-container">

      <!-- 1. Connectivity Section (Formerly Sync Tab) -->
      <mat-card class="connectivity-card" [class.locked]="!hasProAccess" (click)="!hasProAccess && triggerUpsell()">
        @if (!hasProAccess) {
        <div class="lock-overlay">
          <mat-icon class="lock-icon-large">lock</mat-icon>
          <span class="pro-badge">PRO</span>
        </div>
        }
        <mat-card-header>
          @if (!isConnectedToService()) {
          <mat-card-subtitle class="tab-subtitle">
            <span>Connect to Suunto app</span>
            <mat-icon matTooltip="NOTE: Automatic sync happens for activities done after this date">
              info
            </mat-icon>
          </mat-card-subtitle>
          }
          @if (isConnectedToService()) {
          <mat-card-subtitle>Connected</mat-card-subtitle>
          }
        </mat-card-header>
        <mat-divider></mat-divider>
        <mat-card-content class="feature-card-content" style="align-items: flex-start; text-align: left;">
          <mat-progress-bar mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>

          @if (isConnectedToService()) {
          <mat-list style="width: 100%">
            <div mat-subheader>Accounts</div>
            @for (serviceToken of serviceTokens; track serviceToken; let i = $index) {
            <mat-list-item>
              <mat-icon mat-list-icon (click)="clicks = clicks+1">account_circle</mat-icon>
              <div mat-line>{{ serviceToken.userName }} </div>
              <div mat-line>Connected at {{serviceToken.dateCreated | date:'medium'}}</div>
            </mat-list-item>
            }
          </mat-list>
          }

          @if (!isConnectedToService() || clicks > 10) {
          <button mat-stroked-button class="big" mat-flat-button color="primary"
            [disabled]="!user || this.isGuest || isLoading" (click)="connectWithService($event)">Connect
          </button>
          }

          @if (isConnectedToService()) {
          <button class="big" mat-flat-button color="warn" [disabled]="isLoading"
            (click)="deauthorizeService($event)">Disconnect
          </button>
          }
        </mat-card-content>
      </mat-card>

      <!-- 2. Pro Features Grid -->
      <h3 class="section-title">Pro Tools</h3>
      <div class="features-grid">

        <!-- History Import Card -->
        <mat-card class="feature-card" [class.locked]="!hasProAccess" [class.unlocked]="hasProAccess"
          (click)="!hasProAccess && triggerUpsell()">
          <!-- Lock Overlay -->
          @if (!hasProAccess) {
          <div class="lock-overlay">
            <mat-icon class="lock-icon-large">lock</mat-icon>
            <span class="pro-badge">PRO</span>
          </div>
          }

          <mat-card-header>
            <mat-card-subtitle class="tab-subtitle">
              <mat-icon>history</mat-icon>
              <span>History Import</span>
            </mat-card-subtitle>
          </mat-card-header>
          <mat-divider></mat-divider>

          <!-- Content (Blurred if locked) -->
          <div class="feature-card-content">
            <p class="feature-description" *ngIf="!hasProAccess">Import your full activity history from Suunto.</p>
            <app-history-import-form [serviceName]="serviceName"
              [userMetaForService]="serviceMeta"></app-history-import-form>
          </div>
        </mat-card>

        <!-- Download Card -->
        <mat-card class="feature-card" [class.locked]="!hasProAccess" [class.unlocked]="hasProAccess"
          (click)="!hasProAccess && triggerUpsell()">
          @if (!hasProAccess) {
          <div class="lock-overlay">
            <mat-icon class="lock-icon-large">lock</mat-icon>
            <span class="pro-badge">PRO</span>
          </div>
          }
          <mat-card-header>
            <mat-card-subtitle class="tab-subtitle">
              <mat-icon>cloud_download</mat-icon>
              <span>Download FIT</span>
            </mat-card-subtitle>
          </mat-card-header>
          <mat-divider></mat-divider>

          <div class="feature-card-content">
            <p class="feature-description" *ngIf="!hasProAccess">Download FIT files directly from Suunto links.</p>
            <form style="width: 100%" [formGroup]="suuntoAppLinkFormGroup" (submit)="onSubmit()" autocomplete="off"
              class="qs-form">
              <mat-form-field>
                <label>
                  <input matInput placeholder="App Link" formControlName="input">
                </label>
                @if (hasError('input')) {
                <mat-error>Link Required</mat-error>
                }
              </mat-form-field>
              <div class="qs-form-actions" style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button mat-flat-button color="primary" [disabled]="isLoading" (click)="onSubmit()">
                  Download
                </button>
                @if (user) {
                <button mat-flat-button color="accent" [disabled]="isLoading" (click)="onImportAndOpen()">
                  Import
                </button>
                }
              </div>
            </form>
          </div>
        </mat-card>

        <!-- FIT Upload Card -->
        <mat-card class="feature-card" [class.locked]="!hasProAccess" [class.unlocked]="hasProAccess"
          (click)="!hasProAccess && triggerUpsell()">
          @if (!hasProAccess) {
          <div class="lock-overlay">
            <mat-icon class="lock-icon-large">lock</mat-icon>
            <span class="pro-badge">PRO</span>
          </div>
          }
          <mat-card-header>
            <mat-card-subtitle class="tab-subtitle">
              <mat-icon>cloud_upload</mat-icon>
              <span>FIT Upload</span>
            </mat-card-subtitle>
          </mat-card-header>
          <mat-divider></mat-divider>

          <div class="feature-card-content">
            <p class="feature-description" *ngIf="!hasProAccess">Upload standard FIT files to Suunto.</p>
            <app-upload-activity-to-service [user]="user"></app-upload-activity-to-service>
          </div>
        </mat-card>

        <!-- GPX Upload Card -->
        <mat-card class="feature-card" [class.locked]="!hasProAccess" [class.unlocked]="hasProAccess"
          (click)="!hasProAccess && triggerUpsell()">
          @if (!hasProAccess) {
          <div class="lock-overlay">
            <mat-icon class="lock-icon-large">lock</mat-icon>
            <span class="pro-badge">PRO</span>
          </div>
          }
          <mat-card-header>
            <mat-card-subtitle class="tab-subtitle">
              <mat-icon svgIcon="route"></mat-icon>
              <span>GPX Upload</span>
            </mat-card-subtitle>
            @if (serviceMeta && serviceMeta.uploadedRoutesCount && serviceMeta.uploadedRoutesCount > 3) {
            <mat-card-subtitle class="smaller">
              {{serviceMeta.uploadedRoutesCount}} uploaded
            </mat-card-subtitle>
            }
          </mat-card-header>
          <mat-divider></mat-divider>

          <div class="feature-card-content">
            <p class="feature-description" *ngIf="!hasProAccess">Upload GPX routes to Suunto.</p>
            <app-upload-route-to-service [user]="user"></app-upload-route-to-service>
          </div>
        </mat-card>

      </div>
    </div>

  </mat-card-content>
</mat-card>
<app-shade [isActive]="isLoading"></app-shade>