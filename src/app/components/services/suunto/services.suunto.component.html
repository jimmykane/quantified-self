<p class="description-text">
  Suunto is a trusted companion for athletes and adventurers. The durable and precise sports watches are tested in
  the toughest conditions and built to last in adventures from the deepest oceans to the highest mountains.
</p>

<div class="service-container">

  <!-- Pro Features Grid -->
  <h3 class="section-title">Pro Tools</h3>
  <div class="features-grid">

    <!-- Connectivity Card (Now inside Pro Grid) -->
    <mat-card class="feature-card glass-card" [class.locked]="!hasProAccess && !isConnectedToService()"
      [class.unlocked]="hasProAccess || isConnectedToService()"
      (click)="!hasProAccess && !isConnectedToService() && triggerUpsell()">
      @if (!hasProAccess && !isConnectedToService()) {
      <div class="lock-overlay">
        <mat-icon class="lock-icon-large">lock</mat-icon>
        <span class="pro-badge">PRO</span>
      </div>
      }
      <mat-card-header>
        <mat-card-subtitle class="tab-subtitle">
          <mat-icon>sync</mat-icon>
          <span>{{ isConnectedToService() ? 'Connected' : 'Connect Account' }}</span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>
      <mat-card-content class="feature-card-content" style="align-items: stretch; text-align: left;">
        <mat-progress-bar mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>

        @if (isConnectedToService()) {
        @if (!suuntoUserName) {
        <app-service-syncing-state></app-service-syncing-state>
        } @else {
        <mat-list style="width: 100%; padding: 0;">
          @for (serviceToken of serviceTokens; track $index; let i = $index) {
          <mat-list-item style="height: auto; padding: 8px 0;">
            <mat-icon matListItemIcon (click)="clicks = clicks+1" style="margin-right: 8px;">account_circle</mat-icon>
            <div matListItemTitle style="font-size: 0.9rem;">{{ getSuuntoUserName(serviceToken) }} </div>
            <div matListItemLine style="font-size: 0.8rem; opacity: 0.7;">Connected: {{serviceToken.dateCreated |
              date:'short'}}</div>
          </mat-list-item>
          }
        </mat-list>
        }
        }

        <div style="margin-top: auto; padding-top: 16px;">
          @if (!isConnectedToService() || clicks > 10) {
          <button mat-flat-button color="primary" style="width: 100%"
            [disabled]="!user || isLoading || isConnecting || !hasProAccess" (click)="connectWithService($event)">
            @if (isConnecting) {
            <ng-container>
              <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
                color="accent"></mat-spinner>
              Connecting...
            </ng-container>
            } @else {
            <ng-container>
              <mat-icon>link</mat-icon> Connect
            </ng-container>
            }
          </button>
          }

          @if (isConnectedToService()) {
          <button mat-stroked-button color="warn" style="width: 100%" [disabled]="isLoading || isDisconnecting"
            (click)="deauthorizeService($event)">
            @if (isDisconnecting) {
            <ng-container>
              <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
                color="warn"></mat-spinner>
              Disconnecting...
            </ng-container>
            } @else {
            <ng-container>
              <mat-icon>link_off</mat-icon> Disconnect
            </ng-container>
            }
          </button>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- History Import Card -->
    <mat-card class="feature-card glass-card" [class.locked]="!hasProAccess" [class.unlocked]="hasProAccess"
      (click)="!hasProAccess && triggerUpsell()">
      <!-- Lock Overlay -->
      @if (!hasProAccess) {
      <div class="lock-overlay">
        <mat-icon class="lock-icon-large">lock</mat-icon>
        <span class="pro-badge">PRO</span>
      </div>
      }

      <mat-card-header>
        <mat-card-subtitle class="tab-subtitle">
          <mat-icon>history</mat-icon>
          <span>History Import</span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>

      <!-- Content (Blurred if locked) -->
      <div class="feature-card-content">
        <p class="feature-description" *ngIf="!hasProAccess">Import your full activity history from Suunto.</p>
        @if (hasProAccess) {
        @if (isConnectedToService()) {
        <app-history-import-form [serviceName]="serviceName" [userMetaForService]="serviceMeta"
          [isLoadingParent]="isLoading" (importInitiated)="onHistoryImportInitiated()"></app-history-import-form>
        } @else {
        <div
          style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; text-align: center; color: var(--mat-sys-on-surface-variant);">
          <mat-icon
            style="font-size: 40px; height: 40px; width: 40px; margin-bottom: 12px; opacity: 0.5;">link_off</mat-icon>
          <div style="font-weight: 500; font-size: 1rem;">Connect Account First</div>
          <div style="font-size: 0.85rem; margin-top: 4px; opacity: 0.8; max-width: 280px;">
            You need to connect your Suunto account in the section above before importing history.
          </div>
        </div>
        }
        }
      </div>
    </mat-card>

    <!-- Download Card -->
    <mat-card class="feature-card glass-card" [class.locked]="!hasProAccess" [class.unlocked]="hasProAccess"
      (click)="!hasProAccess && triggerUpsell()">
      @if (!hasProAccess) {
      <div class="lock-overlay">
        <mat-icon class="lock-icon-large">lock</mat-icon>
        <span class="pro-badge">PRO</span>
      </div>
      }
      <mat-card-header>
        <mat-card-subtitle class="tab-subtitle">
          <mat-icon>cloud_download</mat-icon>
          <span>Download FIT</span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>

      <div class="feature-card-content">
        <p class="feature-description" *ngIf="!hasProAccess">Download FIT files directly from Suunto links.</p>
        <form style="width: 100%" [formGroup]="suuntoAppLinkFormGroup" (submit)="onSubmit()" autocomplete="off"
          class="qs-form">
          <mat-form-field appearance="outline">
            <mat-label>App Link</mat-label>
            <input matInput placeholder="https://..." formControlName="input">
            @if (hasError('input')) {
            <mat-error>Link Required</mat-error>
            }
          </mat-form-field>
          <div class="qs-form-actions" style="display: flex; gap: 8px;">
            <button mat-flat-button color="primary" [disabled]="isLoading || isDownloading || isImporting"
              (click)="onSubmit()">
              @if (isDownloading) {
              <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
                color="accent"></mat-spinner>
              Downloading...
              } @else {
              Download
              }
            </button>
            @if (user) {
            <button mat-flat-button color="accent" [disabled]="isLoading || isDownloading || isImporting"
              (click)="onImportAndOpen()">
              @if (isImporting) {
              <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
                color="primary"></mat-spinner>
              Importing...
              } @else {
              Import
              }
            </button>
            }
          </div>
        </form>
      </div>
    </mat-card>

    <!-- FIT Upload Card - No (click) handler to allow file input interaction -->
    <mat-card class="feature-card glass-card" [class.locked]="!hasProAccess" [class.unlocked]="hasProAccess">
      @if (!hasProAccess) {
      <div class="lock-overlay" (click)="triggerUpsell()">
        <mat-icon class="lock-icon-large">lock</mat-icon>
        <span class="pro-badge">PRO</span>
      </div>
      }
      <mat-card-header>
        <mat-card-subtitle class="tab-subtitle">
          <mat-icon>cloud_upload</mat-icon>
          <span>Upload FIT Activity</span>
        </mat-card-subtitle>
        @if (suuntoServiceMeta && suuntoServiceMeta.uploadedActivitiesCount && suuntoServiceMeta.uploadedActivitiesCount
        > 0) {
        <mat-card-subtitle class="smaller">
          {{suuntoServiceMeta.uploadedActivitiesCount}} uploaded
        </mat-card-subtitle>
        }
      </mat-card-header>
      <mat-divider></mat-divider>

      <div class="feature-card-content">
        <p class="feature-description" *ngIf="!hasProAccess">Upload standard FIT files to Suunto.</p>
        <app-upload-activity-to-service [user]="user" [hasProAccess]="hasProAccess"></app-upload-activity-to-service>
      </div>
    </mat-card>

    <!-- GPX Upload Card - No (click) handler to allow file input interaction -->
    <mat-card class="feature-card glass-card" [class.locked]="!hasProAccess" [class.unlocked]="hasProAccess">
      @if (!hasProAccess) {
      <div class="lock-overlay" (click)="triggerUpsell()">
        <mat-icon class="lock-icon-large">lock</mat-icon>
        <span class="pro-badge">PRO</span>
      </div>
      }
      <mat-card-header>
        <mat-card-subtitle class="tab-subtitle">
          <mat-icon svgIcon="route"></mat-icon>
          <span>Upload GPX Route</span>
        </mat-card-subtitle>
        @if (suuntoServiceMeta && suuntoServiceMeta.uploadedRoutesCount && suuntoServiceMeta.uploadedRoutesCount > 0) {
        <mat-card-subtitle class="smaller">
          {{suuntoServiceMeta.uploadedRoutesCount}} uploaded
        </mat-card-subtitle>
        }
      </mat-card-header>
      <mat-divider></mat-divider>

      <div class="feature-card-content">
        <p class="feature-description" *ngIf="!hasProAccess">Upload GPX routes to Suunto.</p>
        <app-upload-route-to-service [user]="user" [hasProAccess]="hasProAccess"></app-upload-route-to-service>
      </div>
    </mat-card>

  </div>
</div>