<p class="description-text">
  Garmin designs and builds products that enhance people’s lives. Since the company’s inception, the Garmin brand
  has been defined by its products.
</p>

<div class="service-container">

  <!-- Pro Features Grid -->
  <h3 class="section-title">Pro Tools</h3>
  <div class="features-grid">

    <!-- Connectivity Card (Now inside Pro Grid) -->
    <mat-card class="feature-card glass-card" [class.locked]="!hasProAccess"
      (click)="!hasProAccess && !isConnectedToService() && triggerUpsell()">
      @if (!hasProAccess && !isConnectedToService()) {
      <div class="lock-overlay">
        <mat-icon class="lock-icon-large">lock</mat-icon>
        <span class="pro-badge">PRO</span>
      </div>
      }
      <mat-card-header>
        <mat-card-subtitle class="tab-subtitle">
          <mat-icon>sync</mat-icon>
          <span>{{ isConnectedToService() ? 'Connected' : 'Connect Account' }}</span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>
      <mat-card-content class="feature-card-content" style="align-items: stretch; text-align: left;">
        <mat-progress-bar mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>

        @if (isConnectedToService()) {
        @if (!garminUserID || !hasPermissionsLoaded) {
        <app-service-syncing-state></app-service-syncing-state>
        } @else {
        <mat-list style="width: 100%; padding: 0;">
          <mat-list-item style="height: auto; padding: 8px 0;">
            <mat-icon matListItemIcon style="margin-right: 8px;">account_circle</mat-icon>
            <div matListItemTitle style="font-size: 0.9rem;">{{ garminUserID }} </div>
            <div matListItemLine style="font-size: 0.8rem; opacity: 0.7;">Connected: {{serviceTokens?.[0]?.dateCreated
              | date:'short'}}</div>
          </mat-list-item>
          <mat-list-item style="height: auto; padding: 8px 0;" *ngIf="permissionsLastChangedAt">
            <mat-icon matListItemIcon style="margin-right: 8px;">update</mat-icon>
            <div matListItemTitle style="font-size: 0.9rem;">Permissions Updated</div>
            <div matListItemLine style="font-size: 0.8rem; opacity: 0.7;">{{ permissionsLastChangedAt * 1000 |
              date:'short' }}</div>
          </mat-list-item>
        </mat-list>

        <div *ngIf="missingPermissions.length > 0" class="qs-warning-box" style="margin-top: 16px;">
          <mat-icon>warning</mat-icon>
          <div class="qs-warning-content">
            <strong>Missing Permissions</strong>
            <p>Some features are disabled. Missing permissions:</p>
            <ul>
              <li *ngFor="let permission of missingPermissions">
                <div style="font-weight: 500;">{{ getPermissionLabel(permission) }}</div>
                <div style="opacity: 0.7; font-size: 0.8rem; margin-bottom: 4px;">{{
                  getPermissionExplanation(permission) }}</div>
              </li>
            </ul>
            <p style="margin-top: 8px;"><strong>To update permissions:</strong></p>
            <div style="margin-top: 8px; margin-bottom: 8px;">
              <a (click)="openGarminConnectApp(); $event.preventDefault()" href="javascript:void(0)"
                style="cursor: pointer; font-weight: 500; text-decoration: underline;">Open Garmin Connect</a>
            </div>

            <p style="margin-bottom: 4px;"><strong>Navigate to:</strong></p>
            <ul style="margin-top: 0;">
              <li>
                <strong>Web:</strong> Account Information → Connected Apps
              </li>
              <li>
                <strong>App:</strong> More → Settings → Connected Apps
              </li>
            </ul>
            <p style="margin-top: 4px; opacity: 0.7; font-size: 0.8rem;">
              After updating permissions, reconnect to refresh.
            </p>
          </div>
        </div>
        }
        }

        <div style="margin-top: auto; padding-top: 16px;">
          @if (!isConnectedToService()) {
          <button mat-flat-button color="primary" style="width: 100%"
            [disabled]="!user || this.isGuest || isLoading || isConnecting || !hasProAccess"
            (click)="connectWithService($event)">
            @if (isConnecting) {
            <ng-container>
              <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
                color="accent"></mat-spinner>
              Connecting...
            </ng-container>
            } @else {
            <ng-container>
              <mat-icon>link</mat-icon> Connect
            </ng-container>
            }
          </button>
          }

          @if (isConnectedToService()) {
          <button mat-stroked-button color="warn" style="width: 100%" [disabled]="isLoading || isDisconnecting"
            (click)="deauthorizeService($event)">
            @if (isDisconnecting) {
            <ng-container>
              <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
                color="warn"></mat-spinner>
              Disconnecting...
            </ng-container>
            } @else {
            <ng-container>
              <mat-icon>link_off</mat-icon> Disconnect
            </ng-container>
            }
          </button>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- History Import Card -->
    <!-- History Import Card -->
    <mat-card class="feature-card glass-card" [class.locked]="!hasProAccess" (click)="!hasProAccess && triggerUpsell()">
      @if (!hasProAccess) {
      <div class="lock-overlay">
        <mat-icon class="lock-icon-large">lock</mat-icon>
        <span class="pro-badge">PRO</span>
      </div>
      }
      <mat-card-header>
        <mat-card-subtitle class="tab-subtitle">
          <mat-icon>history</mat-icon>
          <span>History Import</span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>

      <div class="feature-card-content">
        <p class="feature-description" *ngIf="!hasProAccess">Import your full activity history from Garmin Connect.
        </p>
        @if (hasProAccess) {
        @if (isConnectedToService()) {
        <app-history-import-form [serviceName]="serviceName" [userMetaForService]="serviceMeta"
          [missingPermissions]="missingPermissions" [isLoadingParent]="isLoading"
          (importInitiated)="onHistoryImportInitiated()"></app-history-import-form>
        } @else {
        <div
          style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; text-align: center; color: var(--mat-sys-on-surface-variant);">
          <mat-icon
            style="font-size: 40px; height: 40px; width: 40px; margin-bottom: 12px; opacity: 0.5;">link_off</mat-icon>
          <div style="font-weight: 500; font-size: 1rem;">Connect Account First</div>
          <div style="font-size: 0.85rem; margin-top: 4px; opacity: 0.8; max-width: 280px;">
            You need to connect your Garmin account in the section above before importing history.
          </div>
        </div>
        }
        }
      </div>
    </mat-card>

  </div>
</div>