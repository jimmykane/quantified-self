<p class="description-text">
  Garmin designs and builds products that enhance people’s lives. Since the company’s inception, the Garmin brand
  has been defined by its products.
</p>

<div class="service-container">

  <!-- Pro Features Grid -->
  <h3 class="section-title">Pro Tools</h3>
  <div class="features-grid">

    <!-- Connectivity Card (Now inside Pro Grid) -->
    <mat-card class="feature-card glass-card" [class.locked]="!hasProAccess || !isAdmin"
      [class.coming-soon]="hasProAccess && !isAdmin" [class.unlocked]="hasProAccess && isAdmin"
      (click)="!hasProAccess && !isConnectedToService() && triggerUpsell()">
      @if (!hasProAccess && !isConnectedToService()) {
      <div class="lock-overlay">
        <mat-icon class="lock-icon-large">lock</mat-icon>
        <span class="pro-badge">PRO</span>
      </div>
      } @else if (!isAdmin && !isConnectedToService()) {
      <div class="lock-overlay coming-soon-overlay">
        <mat-icon class="lock-icon-large">schedule</mat-icon>
        <span class="pro-badge">COMING SOON</span>
      </div>
      }
      <mat-card-header>
        <mat-card-subtitle class="tab-subtitle">
          <mat-icon>sync</mat-icon>
          <span>{{ isConnectedToService() ? 'Connected' : 'Connect Account' }}</span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>
      <mat-card-content class="feature-card-content" style="align-items: stretch; text-align: left;">
        <mat-progress-bar mode="indeterminate" *ngIf="isLoading"></mat-progress-bar>

        @if (isConnectedToService()) {
        <mat-list style="width: 100%; padding: 0;">
          <mat-list-item style="height: auto; padding: 8px 0;">
            <mat-icon matListItemIcon style="margin-right: 8px;">account_circle</mat-icon>
            <div matListItemTitle style="font-size: 0.9rem;">{{ garminUserID }} </div>
            <div matListItemLine style="font-size: 0.8rem; opacity: 0.7;">Connected: {{serviceTokens?.[0]?.dateCreated
              | date:'short'}}</div>
          </mat-list-item>
          <mat-list-item style="height: auto; padding: 8px 0;" *ngIf="permissionsLastChangedAt">
            <mat-icon matListItemIcon style="margin-right: 8px;">update</mat-icon>
            <div matListItemTitle style="font-size: 0.9rem;">Permissions Updated</div>
            <div matListItemLine style="font-size: 0.8rem; opacity: 0.7;">{{ permissionsLastChangedAt * 1000 |
              date:'short' }}</div>
          </mat-list-item>
        </mat-list>

        <div *ngIf="missingPermissions.length > 0" class="warning-box"
          style="margin-top: 16px; padding: 12px; background-color: rgba(244, 67, 54, 0.1); border-radius: 8px; border: 1px solid rgba(244, 67, 54, 0.3);">
          <div style="display: flex; align-items: flex-start; gap: 12px;">
            <mat-icon style="color: #f44336;">warning</mat-icon>
            <div>
              <strong style="display: block; color: #f44336; margin-bottom: 4px;">Missing Permissions</strong>
              <p style="margin: 0; font-size: 0.85rem; opacity: 0.8;">
                Some features are disabled. Missing permissions:
              </p>
              <ul style="margin: 4px 0 8px 16px; padding: 0; font-size: 0.85rem;">
                <li *ngFor="let permission of missingPermissions">
                  <div style="font-weight: 500;">{{ getPermissionLabel(permission) }}</div>
                  <div style="opacity: 0.7; font-size: 0.8rem; margin-bottom: 4px;">{{
                    getPermissionExplanation(permission) }}</div>
                </li>
              </ul>
              <p style="margin: 8px 0 0 0; font-size: 0.85rem;">
                <strong>To update permissions:</strong>
              </p>
              <ul style="margin: 4px 0 8px 16px; padding: 0; font-size: 0.85rem;">
                <li>
                  <a href="https://connect.garmin.com/modern/account" target="_blank" rel="noopener"
                    style="color: var(--mat-sys-primary);">Garmin Connect Web</a>
                  → Account Information → Connected Apps
                </li>
                <li>
                  <a (click)="openGarminConnectApp()" style="color: var(--mat-sys-primary); cursor: pointer;">
                    Open Garmin Connect App
                  </a>
                  → More → Settings → Connected Apps
                </li>
              </ul>
              <p style="margin: 4px 0 0 0; font-size: 0.8rem; opacity: 0.7;">
                After updating permissions, reconnect to refresh.
              </p>
            </div>
          </div>
        </div>
        }

        <div style="margin-top: auto; padding-top: 16px;">
          @if (!isConnectedToService()) {
          <button mat-flat-button color="primary" style="width: 100%"
            [disabled]="!user || this.isGuest || isLoading || isConnecting || !hasProAccess || !isAdmin"
            (click)="connectWithService($event)">
            @if (isConnecting) {
            <ng-container>
              <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
                color="accent"></mat-spinner>
              Connecting...
            </ng-container>
            } @else {
            <ng-container>
              <mat-icon>link</mat-icon> Connect
            </ng-container>
            }
          </button>
          }

          @if (isConnectedToService()) {
          <button mat-stroked-button color="warn" style="width: 100%" [disabled]="isLoading || isDisconnecting"
            (click)="deauthorizeService($event)">
            @if (isDisconnecting) {
            <ng-container>
              <mat-spinner diameter="20" style="display:inline-block; vertical-align: middle; margin-right: 8px;"
                color="warn"></mat-spinner>
              Disconnecting...
            </ng-container>
            } @else {
            <ng-container>
              <mat-icon>link_off</mat-icon> Disconnect
            </ng-container>
            }
          </button>
          }
        </div>
      </mat-card-content>
    </mat-card>

    <!-- History Import Card -->
    <!-- History Import Card -->
    <mat-card class="feature-card glass-card" [class.locked]="!hasProAccess || (!isAdmin && hasProAccess)"
      [class.coming-soon]="hasProAccess && !isAdmin" [class.unlocked]="hasProAccess && isAdmin"
      (click)="!hasProAccess && triggerUpsell()">
      @if (!hasProAccess) {
      <div class="lock-overlay">
        <mat-icon class="lock-icon-large">lock</mat-icon>
        <span class="pro-badge">PRO</span>
      </div>
      } @else if (!isAdmin) {
      <div class="lock-overlay coming-soon-overlay">
        <mat-icon class="lock-icon-large">schedule</mat-icon>
        <span class="pro-badge">COMING SOON</span>
      </div>
      }
      <mat-card-header>
        <mat-card-subtitle class="tab-subtitle">
          <mat-icon>history</mat-icon>
          <span>History Import</span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-divider></mat-divider>

      <div class="feature-card-content">
        <p class="feature-description" *ngIf="!hasProAccess">Import your full activity history from Garmin Connect.
        </p>
        @if (hasProAccess && isAdmin) {
        <app-history-import-form [serviceName]="serviceName" [userMetaForService]="serviceMeta"
          (importInitiated)="onHistoryImportInitiated()"></app-history-import-form>
        } @else if (hasProAccess) {
        <p class="feature-description">Import history is coming soon for Garmin.</p>
        }
      </div>
    </mat-card>

  </div>
</div>